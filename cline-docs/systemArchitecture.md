# System Architecture

## High-Level Overview
PolicyGlass is a Next.js web application that provides AI-powered policy document analysis. The system consists of:

- **Frontend**: Next.js 15 application with App Router architecture, TypeScript, and Sass for styling
- **Backend**: Server-side processing with Prisma ORM for database operations and API routes
- **Database**: SQLite database (configured via DATABASE_URL environment variable)
- **Authentication**: Comprehensive user authentication system with session management, RBAC, and security features
- **Data Models**: User management, password security, configuration, session tracking, audit logging, password reset functionality, and policy analysis storage

The application follows a client-server architecture where policy documents are processed server-side for security and performance reasons. Users interact through a responsive web interface that provides real-time analysis results with visual flagging of potential issues.

## Database Schema
The application uses Prisma ORM with SQLite database. Key models and relationships:

```mermaid
erDiagram
    USER ||--o{ SESSION : "has"
    USER ||--o{ PASSWORD_HISTORY : "maintains"
    USER ||--o{ RESET_REQUEST : "requests"
    USER ||--o{ AUDIT_LOG : "generates"
    USER ||--o{ USER_SAVED_REPORT : "saves"
    POLICY ||--o{ AUDIT_REPORT : "has"
    POLICY ||--o{ POLICY_JOB : "processed by"
    AUDIT_REPORT ||--o{ SECTION_SCORE : "contains"
    AUDIT_REPORT ||--o{ USER_SAVED_REPORT : "saved by users"
    AUDIT_REPORT ||--o{ POLICY_JOB : "generated by"
    
    USER {
        int id PK
        string username UK
        string email UK
        string password_hash
        string password_salt
        datetime password_last_changed
        boolean is_temp_password
        datetime last_successful_login
        int failed_login_attempts
        boolean account_locked
        boolean piv_verified
        string role
        datetime created_at
    }
    
    PASSWORD_HISTORY {
        int id PK
        int user_id FK
        string password_hash
        string password_salt
        datetime changed_at
    }
    
    SESSION {
        string id PK
        int user_id FK
        datetime session_start
        datetime last_activity
        datetime terminated_at
        string jwt_token
        string ip_address
        string user_agent
        boolean valid
    }
    
    AUDIT_LOG {
        int id PK
        int user_id FK
        datetime event_time
        string event_type
        string description
        string source_ip
        string user_agent
    }
    
    RESET_REQUEST {
        int id PK
        int user_id FK
        string reset_token
        datetime created_at
        datetime expires_at
        boolean used
    }
    
    BANNED_PASSWORD {
        int id PK
        string password
        string source
        datetime created_at
    }
    
    CONFIG {
        int id PK
        string name
        string logo
        int appType
        string use_case
        boolean is_active
    }
    
    POLICY {
        int id PK
        string company_name
        string source_url
        string terms_text
        string raw_response
        datetime created_at
    }
    
    AUDIT_REPORT {
        int id PK
        int policy_id FK
        int total_score
        string letter_grade
        string overall_summary
        string raw_audit_json
        datetime created_at
    }
    
    SECTION_SCORE {
        int id PK
        int report_id FK
        string section_name
        int score
        int max_score
        string commentary
    }
    
    USER_SAVED_REPORT {
        int id PK
        int user_id FK
        int report_id FK
        datetime saved_at
        string display_name
        string notes
    }
    
    POLICY_JOB {
        string id PK
        string job_type
        string source_url
        string status
        int progress_percentage
        string research_status
        datetime research_started_at
        datetime research_completed_at
        string research_error
        float research_confidence
        int policy_id FK
        string audit_status
        datetime audit_started_at
        datetime audit_completed_at
        string audit_error
        float audit_confidence
        int audit_report_id FK
        datetime created_at
        datetime updated_at
        datetime expires_at
    }
```

## Key Processes

### Policy Analysis Workflow
```mermaid
flowchart TD
    A[User Access PolicyGlass] --> B[User Authentication]
    B --> C[Role-Based Access Control]
    C --> D[Policy URL Input]
    D --> E[Create Policy Job]
    E --> F[Queue Job for Processing]
    F --> G[Background Processor]
    
    G --> H[Research Phase]
    H --> I[Extract Policy Content]
    I --> J[Store Policy Data]
    J --> K[Research Complete]
    
    K --> L[Audit Phase]
    L --> M[Generate Audit Report]
    M --> N[Calculate Scores]
    N --> O[Store Audit Results]
    O --> P[Audit Complete]
    
    P --> Q[Results Dashboard]
    Q --> R[Visual Flag Display]
    R --> S[Full Report View Toggle]
    S --> T[User Dashboard Features]
    T --> U[Admin Dashboard Features]
    
    subgraph "Real-time Updates"
        V[WebSocket Connections]
        W[Progress Notifications]
        X[Phase Updates]
        Y[Error Handling]
    end
    
    G -.-> V
    H -.-> W
    L -.-> X
    G -.-> Y
```

### Background Processing System
```mermaid
flowchart TD
    A[Application Startup] --> B[Initialize Background Processor]
    B --> C[Load Pending Jobs]
    C --> D[Processing Queue]
    
    D --> E{Jobs Available?}
    E -->|Yes| F[Process Job]
    E -->|No| G[Wait 5 seconds]
    G --> C
    
    F --> H[Research Phase]
    H --> I[Policy Research Service]
    I --> J{Research Success?}
    J -->|Yes| K[Complete Research]
    J -->|No| L[Mark Research Failed]
    
    K --> M[Audit Phase]
    M --> N[Policy Audit Service]
    N --> O{Audit Success?}
    O -->|Yes| P[Complete Audit]
    O -->|No| Q[Mark Audit Failed]
    
    P --> R[Job Complete]
    L --> S[Job Failed]
    Q --> S
    R --> T[Cleanup & Notify]
    S --> T
    T --> C
    
    subgraph "Concurrent Processing"
        U[Max 3 Jobs]
        V[Queue Management]
        W[Error Recovery]
    end
```

## File Structure
- **policyglass/src/app/**: Next.js App Router pages and layout components
  - **home/**: Main landing page with policy analysis input
  - **login/**: User login interface
  - **register/**: User registration interface
  - **dashboard/**: Authenticated user dashboard with role-based content
  - **admin/**: Administrative dashboard and user management
  - **results/**: Analysis results display with flags, warnings, and toggleable full report view
  - **api-docs/**: API documentation interface
  - **layout.tsx**: Root layout with font configuration and global styles
  - **page.tsx**: Default landing page
- **policyglass/src/app/api/**: API routes for authentication, policy analysis, and admin functionality
  - **auth/**: Authentication-related API endpoints (login, logout, register, password reset, verify)
  - **admin/**: Admin-only API endpoints (user management)
  - **policy/**: Policy analysis API endpoints
    - **[id]/**: Individual policy retrieval
    - **jobs/**: Job management endpoints (create, status, cancel)
    - **jobs/[jobId]/**: Individual job status and WebSocket connections
    - **research/**: Policy research endpoints
  - **health/**: System health monitoring endpoints
  - **docs/**: API documentation endpoints
- **policyglass/src/app/controllers/**: Controller layer for handling business logic
  - **auth.controller.ts**: Authentication-related business logic
  - **admin.controller.ts**: Admin-related business logic
  - **policy.controller.ts**: Policy analysis business logic
- **policyglass/src/app/services/**: Service layer for handling data access and external library concerns
  - **auth.service.ts**: Authentication data operations and user management
  - **admin.service.ts**: Admin data operations and user management
  - **password.service.ts**: Password hashing, validation, and reset operations
  - **session.service.ts**: Session management and validation operations
  - **audit.service.ts**: Audit logging operations
  - **policy-job.service.ts**: Policy job lifecycle management and database operations
  - **policy-research.service.ts**: Policy document research and extraction
  - **policy-audit.service.ts**: Policy audit report generation and analysis
  - **background-processor.service.ts**: Background job processing orchestration
  - **websocket.service.ts**: Real-time WebSocket communication management
  - **app-initializer.service.ts**: Application startup and service initialization
- **policyglass/src/app/components/**: Reusable React components for authentication and UI
- **policyglass/src/app/lib/**: Utility functions for session management and authentication
  - **schemas/**: Zod validation schemas for policy audit types
- **policyglass/src/app/types/**: TypeScript type definitions for policy audit system
- **policyglass/src/generated/**: Generated Prisma client code
- **policyglass/prisma/**: Database schema and Prisma configuration
  - **schema.prisma**: Data models for users, sessions, audit logs, policy documents, policy jobs, and analysis results
- **memory-bank/**: Project memory and context documentation
- **cline-docs/**: System documentation and glossary
